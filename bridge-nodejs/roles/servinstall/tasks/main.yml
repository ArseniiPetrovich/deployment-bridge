---
- name: "Install docker-compose@bridge.service"
  copy:
    dest: "/lib/systemd/system/docker-compose@bridge.service"
    content: |
      [Unit]
      Description= bridge service with docker compose
      Requires=docker.service
      After=docker.service

      [Service]
      Restart=always
      RestartSec=50

      WorkingDirectory={{ bridge_path }}

      # Remove old containers, images and volumes
      ExecStartPre=/usr/local/bin/docker-compose down -v
      ExecStartPre=/usr/local/bin/docker-compose rm -fv

      # Compose up
      ExecStart=/usr/local/bin/docker-compose up

      # Run services
      ExecStartPost=-/bin/bash -c '/usr/local/bin/docker-compose run --detach bridge npm run watcher:signature-request'
      ExecStartPost=-/bin/bash -c '/usr/local/bin/docker-compose run --detach bridge npm run watcher:collected-signatures'
      ExecStartPost=-/bin/bash -c '/usr/local/bin/docker-compose run --detach bridge npm run watcher:affirmation-request'
      ExecStartPost=-/bin/bash -c '/usr/local/bin/docker-compose run --detach bridge npm run sender:home'
      ExecStartPost=-/bin/bash -c '/usr/local/bin/docker-compose run --detach bridge npm run sender:foreign'

      # Compose down, remove containers and volumes
      ExecStop=/usr/local/bin/docker-compose down -v

      [Install]
      WantedBy=multi-user.target

- name: "Enable docker-compose@bridge.service"
  systemd:
    name: "docker-compose@bridge.service"
    daemon_reload: yes
    enabled: yes

- name: "Start docker-compose@bridge.service"
  systemd:
    state: started
    name: "docker-compose@bridge.service"
